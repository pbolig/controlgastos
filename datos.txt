Para activar entorno virtual en cmd como admin: .venv\Scripts\activate

ejecutar en desarrollo --> python app.py

Manual de Despliegue: Sistema de Control de Gastos
Infraestructura: VPS CentOS 8 con Plesk Obsidian + Docker. Dominio: gastos.accesovirtual.com.ar Repositorio: https://github.com/pbolig/controlgastos

1. Prerrequisitos del Sistema
Instalaci√≥n de las herramientas necesarias para el despliegue.

Comandos:

Bash

# Instalar Git
yum install git -y

# Instalar Docker
yum install docker-ce docker-ce-cli containerd.io -y

# Habilitar y arrancar Docker
systemctl start docker
systemctl enable docker
‚úÖ Control y Verificaci√≥n:

Bash

# Verificar versi√≥n de Git
git --version

# Verificar que Docker est√° corriendo (debe decir "Active: active")
systemctl status docker | grep Active
2. Creaci√≥n del Subdominio en Plesk
Creamos el subdominio definiendo expl√≠citamente una carpeta ra√≠z personalizada (gastos) para aislarlo de la carpeta principal httpdocs.

Comandos:

Bash

plesk bin subdomain --create gastos -domain accesovirtual.com.ar -www-root gastos
‚úÖ Control y Verificaci√≥n:

Bash

# Verificar que Plesk reconoce el subdominio y la ruta correcta
plesk bin subdomain --info gastos.accesovirtual.com.ar | grep "WWW-Root"
# Resultado esperado: --WWW-Root--: /var/www/vhosts/accesovirtual.com.ar/gastos
3. Descarga del C√≥digo Fuente
Navegamos a la carpeta del subdominio, limpiamos los archivos por defecto y clonamos el repositorio.

Comandos:

Bash

# Ir a la carpeta
cd /var/www/vhosts/accesovirtual.com.ar/gastos

# Limpiar archivo default de Plesk
rm -f index.html

# Clonar repo (el punto al final es obligatorio)
git clone https://github.com/pbolig/controlgastos .
‚úÖ Control y Verificaci√≥n:

Bash

# Listar archivos para confirmar que baj√≥ el c√≥digo
ls -la
# Resultado esperado: Debes ver 'app.py', 'Dockerfile', 'requirements.txt', etc.
4. Construcci√≥n de la Imagen Docker
Empaquetamos la aplicaci√≥n y sus dependencias.

Comandos:

Bash

docker build -t gastos-app .
‚úÖ Control y Verificaci√≥n:

Bash

# Verificar que la imagen se cre√≥ correctamente
docker images | grep gastos-app
# Resultado esperado: Una l√≠nea mostrando 'gastos-app' y su tama√±o.
5. Configuraci√≥n de Persistencia
Preparamos la carpeta externa donde se guardar√° la base de datos activa.

Comandos:

Bash

mkdir -p /var/www/gastos-data
‚úÖ Control y Verificaci√≥n:

Bash

ls -ld /var/www/gastos-data
6. Ejecuci√≥n del Contenedor
Arrancamos la aplicaci√≥n conectando puertos y vol√∫menes.

Comandos: (Reemplazar TuClaveSecreta por la contrase√±a real)

Bash

docker run -d \
  --name control-gastos-container \
  --restart=always \
  -p 127.0.0.1:5000:5000 \
  -v /var/www/gastos-data:/app/instance \
  -e APP_PASSWORD="TuClaveSecreta" \
  gastos-app
‚úÖ Control y Verificaci√≥n:

Bash

# 1. Verificar que el contenedor est√° corriendo (STATUS Up)
docker ps | grep control-gastos-container

# 2. Verificar respuesta interna
curl -I http://127.0.0.1:5000
7. Inicializaci√≥n de Base de Datos (Solo 1ra vez)
Comandos:

Bash

docker exec control-gastos-container python db_setup.py
‚úÖ Control y Verificaci√≥n:

Bash

# Confirmar existencia del archivo .db
ls -l /var/www/gastos-data/gastos.db
8. Configuraci√≥n del Proxy Inverso (Nginx)
Configuramos Nginx usando una regla Regex (~ ^/) para evitar conflictos con Plesk.

a) Crear archivo de configuraci√≥n:

Bash

cat <<EOF > /var/www/vhosts/system/gastos.accesovirtual.com.ar/conf/vhost_nginx.conf
location ~ ^/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
}
EOF
b) Aplicar configuraci√≥n en Plesk:

Bash

plesk sbin httpdmng --reconfigure-domain gastos.accesovirtual.com.ar
‚úÖ Control y Verificaci√≥n:

Bash

# Verificar sintaxis
nginx -t
# Verificar respuesta HTTP externa (Debe devolver 200 o 302)
curl -I http://gastos.accesovirtual.com.ar
9. Certificado de Seguridad (SSL/HTTPS)
Comandos:

Bash

plesk bin extension --exec letsencrypt cli.php -d gastos.accesovirtual.com.ar
(Si falla la visualizaci√≥n tras esto, re-ejecutar el comando de reconfiguraci√≥n del Paso 8b).

‚úÖ Control y Verificaci√≥n Final:

Bash

curl -I https://gastos.accesovirtual.com.ar
10. Automatizaci√≥n de Backups y Rotaci√≥n
Configuraremos un script que realiza una copia diaria y elimina autom√°ticamente los backups que excedan los 3 d√≠as de antig√ºedad.

a) Crear directorio de backups:

Bash

mkdir -p /var/www/gastos-backups
b) Crear el script de backup: Copia y pega el siguiente bloque completo para crear el script:

Bash

cat <<EOF > /root/backup_gastos.sh
#!/bin/bash

# Configuraci√≥n
BACKUP_DIR="/var/www/gastos-backups"
SOURCE_DB="/var/www/gastos-data/gastos.db"
DATE=\$(date +%Y-%m-%d_%H%M%S)
FILENAME="gastos_backup_\$DATE.db"

# 1. Realizar la copia de seguridad
cp \$SOURCE_DB \$BACKUP_DIR/\$FILENAME

# 2. Rotaci√≥n: Mantener solo los 3 archivos m√°s recientes
# (Lista por fecha descendente, salta los primeros 3 y borra el resto)
ls -1t \$BACKUP_DIR/*.db | tail -n +4 | xargs -r rm -f

EOF
c) Dar permisos de ejecuci√≥n:

Bash

chmod +x /root/backup_gastos.sh
d) Probar el script manualmente: Ejecuta el script una vez para asegurar que funciona.

Bash

/root/backup_gastos.sh
‚úÖ Control y Verificaci√≥n:

Bash

# Deber√≠a aparecer un archivo .db con la fecha de hoy
ls -l /var/www/gastos-backups/
e) Programar la Tarea Cron (Diaria a las 03:00 AM): A√±adimos la tarea al crontab del usuario root.

Bash

(crontab -l 2>/dev/null; echo "0 3 * * * /root/backup_gastos.sh") | crontab -
‚úÖ Control y Verificaci√≥n:

Bash

# Verificar que la tarea qued√≥ guardada
crontab -l | grep backup_gastos
üîÑ Rutina de Mantenimiento (Actualizaci√≥n)
cd /var/www/vhosts/accesovirtual.com.ar/gastos

git pull

docker build -t gastos-app .

docker rm -f control-gastos-container

Ejecutar comando docker run del Paso 6.